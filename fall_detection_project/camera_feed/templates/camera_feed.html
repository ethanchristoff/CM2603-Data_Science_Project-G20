{% load static %} <!-- Using this to load the static elements into the page-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camera Feed | FallGuard Pro</title>
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="{% static 'css/camera.css' %}"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="{% static 'JS/camera.js' %}" defer></script>
  
  <style>
    .news-bar {
      background-color: var(--success-color);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
      transition: background-color 0.5s ease;
      box-shadow: var(--card-shadow);
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background-color: #2c5282;">
    <div class="container-fluid">
      <button class="btn btn-link text-white" id="toggleSidebar">
        <i class="bi bi-list fs-4"></i>
      </button>
      <a class="navbar-brand ms-3" href="#">
        <i class="bi bi-shield-check me-2"></i>FallGuard Pro
      </a>
      <div class="ms-auto d-flex align-items-center">
        <div class="position-relative me-4">
          <button class="btn btn-link position-relative text-white">
            <i class="bi bi-bell fs-5"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">3</span>
          </button>
        </div>
        <div class="dropdown">
          <button class="btn dropdown-toggle d-flex align-items-center border-0" type="button" data-bs-toggle="dropdown">
            <span class="text-white d-none d-md-inline">John Doe</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <li class="dropdown-header">
              <strong>John Doe</strong>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'profile_page' %}"><i class="bi bi-person me-2"></i>Profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#Logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar text-white" id="sidebar">
    <ul class="nav nav-pills flex-column mt-2">
      <li class="nav-item">
        <a class="nav-link text-white" href="{% url 'dashboard' %}">
          <i class="bi bi-speedometer2 me-2"></i><span class="sidebar-text">Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white" href="{% url 'weekly-report' %}">
          <i class="bi bi-graph-up me-2"></i><span class="sidebar-text">Weekly Report</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white active">
          <i class="bi bi-camera-video-fill me-2"></i><span class="sidebar-text">Live Feed</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white">
          <i class="bi bi-gear me-2"></i><span class="sidebar-text">Settings</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white">
          <i class="bi bi-question-circle me-2"></i><span class="sidebar-text">Help</span>
        </a>
      </li>
    </ul>
    
    <div class="px-3 mt-auto mb-3 d-flex align-items-center text-white-50 small" style="position: absolute; bottom: 0; left: 0; right: 0;">
      <span class="status-indicator status-active"></span>
      <span class="sidebar-text">System active</span>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-12">
          <h1 class="h3 mb-2 mt-1">Live Camera Feed</h1>
          <p class="text-muted">Monitor and detect potential falls in real-time</p>
        </div>
      </div>
      
      <!-- Status Bar -->
      <div class="news-bar" id="newsBar">
        <div class="d-flex align-items-center">
          <i class="bi bi-shield-check fs-4 me-2"></i>
          <p id="newsText" class="mb-0">System is monitoring for falls...</p>
        </div>
      </div>
      
      <!-- Camera Feed Card -->
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3">
          <!-- Camera Controls -->
          <div class="control-buttons d-flex justify-content-center mb-3">
            <button id="startButton" class="btn btn-success btn-lg mx-2">
              <i class="bi bi-play-fill me-1"></i> Start Tracking
            </button>
            <button id="stopButton" class="btn btn-danger btn-lg mx-2" disabled>
              <i class="bi bi-stop-fill me-1"></i> Stop Tracking
            </button>
          </div>

          <!-- Camera Feed -->
          <div class="camera-feed">
            <div class="text-center">
              <img id="cameraFeed" width="640" height="480" alt="Live Camera Feed" style="display: none;">
              <div id="cameraPlaceholder" class="bg-light p-5 rounded text-center d-flex flex-column align-items-center justify-content-center" style="width: 640px; height: 480px;">
                <i class="bi bi-camera-video-off fs-1 text-muted"></i>
                <p class="mt-3 mb-0">Camera feed not active</p>
                <p class="text-muted small">Click 'Start Tracking' to begin monitoring</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Past Recordings Section -->
      <div class="recordings-section mt-4">
        <div class="d-flex justify-content-between align-items-center">
          <h2><i class="bi bi-collection-play me-2"></i>Past Fall Recordings</h2>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-funnel me-1"></i>Filter
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">Today</a></li>
              <li><a class="dropdown-item" href="#">Last 7 days</a></li>
              <li><a class="dropdown-item" href="#">Last 30 days</a></li>
            </ul>
          </div>
        </div>
        
        {% if videos %}
          <div class="slider-container">
            <button class="slider-btn prev" onclick="prevVideo()">&#10094;</button>
            <div class="slider-wrapper">
              <div class="slider" id="videoSlider">
                {% for video in videos %}
                  <div class="video-wrapper">
                    <video width="400" controls poster="{% static 'images/video-thumbnail.jpg' %}">
                      <source src="{{ MEDIA_URL }}recordings/{{ video }}" type="video/mp4">
                      Your browser does not support the video tag.
                    </video>
                    <div class="text-center mt-2">
                      <small class="text-muted">{{ video.date_captured|date:"M d, Y - h:i A" }}</small>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <button class="slider-btn next" onclick="nextVideo()">&#10095;</button>
          </div>
        {% else %}
          <div class="text-center p-5">
            <i class="bi bi-film fs-1 text-muted"></i>
            <p class="mt-3">No recordings found</p>
            <small class="text-muted">Recordings will appear here when falls are detected</small>
          </div>
        {% endif %}
      </div>
    </div>
  </main>

  <script>
    // Toggle sidebar
    document.getElementById("toggleSidebar").addEventListener("click", function() {
      const sidebar = document.getElementById("sidebar");
      const mainContent = document.querySelector(".main-content");
      
      sidebar.classList.toggle("collapsed");
      
      if (sidebar.classList.contains("collapsed")) {
        mainContent.style.marginLeft = "60px";
        
        // Hide text in sidebar
        const sidebarTexts = document.querySelectorAll(".sidebar-text");
        sidebarTexts.forEach(text => {
          text.style.display = "none";
        });
      } else {
        mainContent.style.marginLeft = "250px";
        
        // Show text in sidebar
        const sidebarTexts = document.querySelectorAll(".sidebar-text");
        sidebarTexts.forEach(text => {
          text.style.display = "inline";
        });
      }
    });
    
    function checkFallStatus() {
      console.log("Checking fall status..."); // Debugging log
  
      fetch('/camera_feed/get_fall_status/')
        .then(response => response.json())
        .then(data => {
          console.log("Fetched fall status:", data);
  
          const newsBar = document.getElementById('newsBar');
          const newsText = document.getElementById('newsText');
  
          if (data.fall_detected) {
            newsBar.style.backgroundColor = '#e53e3e';
            newsText.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i> <strong>Fall Detected!</strong> Immediate action required.';
            
            // Add animation to make it more noticeable
            newsBar.style.animation = "pulse 1.5s infinite";
          } else {
            newsBar.style.backgroundColor = '#38a169';
            newsBar.style.animation = "none";
            newsText.innerHTML = '<i class="bi bi-check-circle me-2"></i> No Falls Detected. All clear.';
          }
        })
        .catch(error => console.error('Error fetching fall status:', error));
    }

    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const cameraFeed = document.getElementById('cameraFeed');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');

    startButton.addEventListener('click', () => {
      cameraFeed.src = "{% url 'live_feed' %}";
      cameraFeed.style.display = 'block';
      cameraPlaceholder.style.display = "none";
      cameraPlaceholder.style.visibility = "hidden";
      startButton.disabled = true;
      stopButton.disabled = false;
      
      // Show loading animation briefly
      cameraFeed.classList.add('opacity-50');
      setTimeout(() => {
        cameraFeed.classList.remove('opacity-50');
      }, 1000);
    });

    stopButton.addEventListener('click', () => {
      cameraFeed.src = '';  // Stops the feed
      cameraFeed.style.display = 'none';
      cameraPlaceholder.style.visibility = "visible";
      cameraPlaceholder.style.display = 'flex';
      startButton.disabled = false;
      stopButton.disabled = true;
    });

    // Video slider functions
    let currentPosition = 0;
    const slideAmount = 420; // Width of video plus margin

    function nextVideo() {
      const slider = document.getElementById('videoSlider');
      const videoCount = slider.children.length;
      
      if (currentPosition < (videoCount - 1) * slideAmount) {
        currentPosition += slideAmount;
        slider.style.transform = `translateX(-${currentPosition}px)`;
      }
    }

    function prevVideo() {
      const slider = document.getElementById('videoSlider');
      
      if (currentPosition > 0) {
        currentPosition -= slideAmount;
        slider.style.transform = `translateX(-${currentPosition}px)`;
      }
    }

    // Run checkFallStatus() every 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
      checkFallStatus();
      setInterval(checkFallStatus, 5000);
      
      // Add animation style for fall detection alerts
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse {
          0% { opacity: 1; }
          50% { opacity: 0.8; }
          100% { opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>