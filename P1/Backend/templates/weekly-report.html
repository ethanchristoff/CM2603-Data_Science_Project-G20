{% extends "base.html" %}
{% block page_style %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  <!-- Chart.js -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
        .chart-container {
            height: 300px;
        }

        /* Previous styles remain the same */
        @media print {
            .navbar, .sidebar, .no-print {
                display: none !important;
            }
            .main-content {
                margin-left: 0 !important;
                margin-top: 0 !important;
            }
            .card {
                break-inside: avoid;
            }
        }

        .print-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: var(--healthcare-blue-light) !important;
            border-color: var(--healthcare-blue-light) !important;
        }

        .print-button:hover {
            background-color: var(--healthcare-blue) !important;
            border-color: var(--healthcare-blue) !important;
        }
    </style>
{% endblock %}
{% block content %}
<!-- Main Content -->

        <!-- Print Button -->
        <button class="btn btn-primary print-button no-print" onclick="generatePDF()" id="printButton">
            <i class="bi bi-printer me-2"></i>Download Report as PDF
        </button>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Total Falls This Week</h6>
                        <h2 class="card-title mb-0">2</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Current Heart Rate</h6>
                        <h2 class="card-title mb-0">72 bpm</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Movement Level</h6>
                        <h2 class="card-title mb-0">65%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Alerts</h6>
                        <h2 class="card-title mb-0">3</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Falls Distribution (Weekly)</h5>
                        <div class="chart-container">
                            <canvas id="fallsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Average Heart Rate</h5>
                        <div class="chart-container">
                            <canvas id="heartRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Daily Movement Trend</h5>
                        <div class="chart-container">
                            <canvas id="movementChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Active Monitors</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="status-dot bg-success me-2"></span>
                                    Camera 1
                                </div>
                                <span class="text-muted">Room 1</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}
{% block script %}
<script>
    async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    // Hide the print button
    const button = document.getElementById("printButton");
    button.style.display = "none";

    // Define margins and dimensions
    const margin = 15;
    const pageWidth = 210; // A4 width
    const contentWidth = pageWidth - (2 * margin);

    // Header with logo
    pdf.setFillColor(44, 82, 130);
    pdf.rect(margin, margin, 35, 8, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(12);
    pdf.setFont("helvetica", "bold");
    pdf.text("FallGuard Pro", margin + 3, margin + 5.5);

    // Report title
    pdf.setTextColor(44, 82, 130);
    pdf.setFontSize(16);
    pdf.text("Weekly Health Monitoring Report", margin + 39, margin + 6);

    // Patient info in compact two-column layout
    const infoStartY = margin + 15;
    pdf.setFontSize(10);
    pdf.setTextColor(0, 0, 0);

    // Left column
    pdf.setFont("helvetica", "bold");
    pdf.text("Patient:", margin, infoStartY);
    pdf.setFont("helvetica", "normal");
    pdf.text("John Doe", margin + 20, infoStartY);

    pdf.setFont("helvetica", "bold");
    pdf.text("Report Period:", margin, infoStartY + 5);
    pdf.setFont("helvetica", "normal");
    pdf.text(getDateRange(), margin + 30, infoStartY + 5);

    // Right column
    const rightCol = pageWidth / 2 + 10;
    pdf.setFont("helvetica", "bold");
    pdf.text("Age:", rightCol, infoStartY);
    pdf.setFont("helvetica", "normal");
    pdf.text("66", rightCol + 15, infoStartY);

    pdf.setFont("helvetica", "bold");
    pdf.text("Generated:", rightCol, infoStartY + 5);
    pdf.setFont("helvetica", "normal");
    pdf.text(formatDateTime(new Date()), rightCol + 25, infoStartY + 5);

    // Summary statistics in a compact grid
    const summaryY = infoStartY + 15;
    const stats = [
        { label: "Total Falls", value: "2" },
        { label: "Avg Heart Rate", value: "72 bpm" },
        { label: "Movement Level", value: "65%" },
        { label: "Total Alerts", value: "3" }
    ];

    pdf.setFillColor(240, 240, 240);
    pdf.rect(margin, summaryY, contentWidth, 12, 'F');

    const statWidth = contentWidth / 4;
    stats.forEach((stat, index) => {
        const xPos = margin + (statWidth * index);
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(9);
        pdf.text(stat.label, xPos + 5, summaryY + 4);
        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(11);
        pdf.text(stat.value, xPos + 5, summaryY + 9);
    });

    // Charts section with better proportions
    const content = document.querySelector('.main-content');
    const charts = content.querySelectorAll('.chart-container');

    let chartY = summaryY + 20;
    const chartHeight = 50; // Base height for charts
    const chartWidth = contentWidth * 0.8; // Reduced width to maintain aspect ratio
    const chartX = margin + ((contentWidth - chartWidth) / 2); // Center the chart

    for (let i = 0; i < 3; i++) { // Only process the first 3 charts
        const canvas = charts[i].querySelector('canvas');
        const chartTitle = canvas.closest('.card').querySelector('.card-title').textContent;

        // Chart title
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(11);
        pdf.setTextColor(44, 82, 130);
        pdf.text(chartTitle, margin, chartY);

        // Add chart background and border
        pdf.setFillColor(252, 252, 252);
        pdf.setDrawColor(220, 220, 220);
        pdf.setLineWidth(0.5);
        pdf.roundedRect(chartX - 2, chartY + 3, chartWidth + 4, chartHeight + 4, 2, 2, 'FD');

        // Capture and add chart
        await html2canvas(canvas, {
            scale: 3,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', chartX, chartY + 5, chartWidth, chartHeight);
        });

        chartY += chartHeight + 20; // Space between charts
    }

    // Footer
    const footerY = 280;
    pdf.setDrawColor(44, 82, 130);
    pdf.setLineWidth(0.2);
    pdf.line(margin, footerY, pageWidth - margin, footerY);

    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(8);
    pdf.setTextColor(100, 100, 100);
    pdf.text("Generated by FallGuard Pro", margin, footerY + 4);
    pdf.text(`Report ID: ${generateReportId()}`, margin, footerY + 7);
    pdf.text("Page 1 of 1", pageWidth - margin - 15, footerY + 4);

    // Restore button and save PDF
    button.style.display = "block";
    pdf.save(`FallGuard_Report_${formatDate(new Date())}.pdf`);
}

// Helper functions remain the same
function getDateRange() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 7);
    return `${formatDate(start)} to ${formatDate(end)}`;
}

function formatDate(date) {
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

function formatDateTime(date) {
    return `${formatDate(date)} ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
}

function generateReportId() {
    return 'RPT-' + Math.random().toString(36).substr(2, 9).toUpperCase();
}
</script>
{% endblock %}



